import{_ as t,H as o,o as e,c as p,C as s,a as l,J as r,V as a}from"./chunks/framework.df15cb86.js";const _=JSON.parse('{"title":"UPLOAD","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"api/upload.md","filePath":"api/upload.md"}'),c={name:"api/upload.md"},d={id:"upload",tabindex:"-1"},F=s("a",{class:"header-anchor",href:"#upload","aria-label":'Permalink to "UPLOAD <Badge type="tip" text="已发布" />"'},"​",-1),y=a('<p>将本地资源上传到开发者服务器，客户端发起一个 <code>POST</code> 请求，其中 <code>content-type</code> 为 <code>multipart/form-data</code>。 如页面通过 <a href="https://uniapp.dcloud.net.cn/api/media/image#chooseimage" target="_blank" rel="noreferrer">uni.chooseImage</a> 等接口获取到一个本地资源的临时文件路径后，可通过此接口将本地资源上传到指定服务器。</p><div class="warning custom-block"><p class="custom-block-title">注意事项</p><p>在各个小程序平台运行时，网络相关的 API 在使用前需要配置域名白名单。在h5上是跨域的，开发者需要处理好跨域问题。</p></div><h2 id="请求参数" tabindex="-1">请求参数 <a class="header-anchor" href="#请求参数" aria-label="Permalink to &quot;请求参数&quot;">​</a></h2>',3),D=s("table",null,[s("thead",null,[s("tr",null,[s("th",null,"参数名"),s("th",null,"类型"),s("th",null,"必填"),s("th",null,"说明"),s("th",null,"平台差异说明")])]),s("tbody",null,[s("tr",null,[s("td",null,"url"),s("td",null,[s("code",null,"String")]),s("td",null,"是"),s("td",null,"开发者服务器 url"),s("td")]),s("tr",null,[s("td",null,"files"),s("td",null,[s("code",null,"Array")]),s("td",null,"是（files和filePath选其一）"),s("td",null,[l("需要上传的文件列表。"),s("strong",null,"使用 files 时，filePath 和 name 不生效"),l("。")]),s("td",null,"App、H5（ 2.6.15+）")]),s("tr",null,[s("td",null,"fileType"),s("td",null,[s("code",null,"String")]),s("td",null,"见平台差异说明"),s("td",null,"文件类型，image/video/audio"),s("td",null,"仅支付宝小程序，且必填。")]),s("tr",null,[s("td",null,"file"),s("td",null,[s("code",null,"File")]),s("td",null,"否"),s("td",null,"要上传的文件对象。"),s("td",null,"仅H5（2.6.15+）支持")]),s("tr",null,[s("td",null,"filePath"),s("td",null,[s("code",null,"String")]),s("td",null,"是（files和filePath选其一）"),s("td",null,"要上传文件资源的路径。"),s("td")]),s("tr",null,[s("td",null,"name"),s("td",null,[s("code",null,"String")]),s("td",null,"是"),s("td",null,"文件对应的 key , 开发者在服务器端通过这个 key 可以获取到文件二进制内容"),s("td")]),s("tr",null,[s("td",null,"domain"),s("td",null,[s("code",null,"String")]),s("td",null,"否"),s("td",null,[l("上传服务器域名，设置该参数时 "),s("code",null,"全局配置"),l(" 的 "),s("code",null,"baseUrl"),l(" 将失效。")]),s("td")]),s("tr",null,[s("td",null,"header"),s("td",null,[s("code",null,"Object")]),s("td",null,"否"),s("td",null,"HTTP 请求 Header, header 中不能设置 Referer。"),s("td")]),s("tr",null,[s("td",null,"timeout"),s("td",null,[s("code",null,"Number")]),s("td",null,"否"),s("td",null,[l("超时时间，单位 ms，默认值为 "),s("code",null,"60000")]),s("td",null,"H5(HBuilderX 2.9.9+)、APP(HBuilderX 2.9.9+)、微信小程序、支付宝小程序、字节跳动小程序、快手小程序")]),s("tr",null,[s("td",null,"formData"),s("td",null,[s("code",null,"Object")]),s("td",null,"否"),s("td",null,"HTTP 请求中其他额外的 form data"),s("td")]),s("tr",null,[s("td",null,"success"),s("td",null,[s("code",null,"Function")]),s("td",null,"否"),s("td",{"tempFilePath:":"",文件的临时路径:""},"下载成功后以 tempFilePath 的形式传给页面，res ="),s("td")]),s("tr",null,[s("td",null,"fail"),s("td",null,[s("code",null,"Function")]),s("td",null,"否"),s("td",null,"接口调用失败的回调函数"),s("td")]),s("tr",null,[s("td",null,"complete"),s("td",null,[s("code",null,"Function")]),s("td",null,"否"),s("td",null,"接口调用结束的回调函数（调用成功、失败都会执行）"),s("td")])])],-1),i=a(`<div class="tip custom-block"><p class="custom-block-title">注意</p><ul><li>App支持多文件上传，微信小程序只支持单文件上传，传多个文件需要反复调用本API。所以跨端的写法就是循环调用本API。</li><li>App平台选择和上传非图像、视频文件，参考<a href="https://ask.dcloud.net.cn/article/35547" target="_blank" rel="noreferrer">https://ask.dcloud.net.cn/article/35547</a></li><li>支付宝小程序开发工具上传文件返回的http状态码为字符串形式，支付宝小程序真机返回的状态码为数字形式</li></ul></div><h4 id="files-参数说明" tabindex="-1">files 参数说明 <a class="header-anchor" href="#files-参数说明" aria-label="Permalink to &quot;files 参数说明&quot;">​</a></h4><p>files 参数是一个 file 对象的数组，file 对象的结构如下：</p><table><thead><tr><th>参数名</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>name</td><td><code>String</code></td><td>否</td><td>multipart 提交时，表单的项目名，默认为 file</td></tr><tr><td>file</td><td><code>File</code></td><td>否</td><td>要上传的文件对象，仅H5（2.6.15+）支持</td></tr><tr><td>uri</td><td><code>String</code></td><td>是</td><td>文件的本地地址</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">注意</p><ul><li>如果 <code>name</code> 不填或填的值相同，可能导致服务端读取文件时只能读取到一个文件。</li></ul></div><h4 id="success-返回参数说明" tabindex="-1">success 返回参数说明 <a class="header-anchor" href="#success-返回参数说明" aria-label="Permalink to &quot;success 返回参数说明&quot;">​</a></h4><table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>data</td><td><code>String</code></td><td>开发者服务器返回的数据</td></tr><tr><td>statusCode</td><td><code>String</code></td><td>开发者服务器返回的 HTTP 状态码</td></tr></tbody></table><h2 id="返回值" tabindex="-1">返回值 <a class="header-anchor" href="#返回值" aria-label="Permalink to &quot;返回值&quot;">​</a></h2><p>返回值为 <code>uploadTask</code> 对象。通过 <code>uploadTask</code>，可监听上传进度变化事件，以及取消上传任务。</p><h4 id="uploadtask-对象的方法列表" tabindex="-1">uploadTask 对象的方法列表 <a class="header-anchor" href="#uploadtask-对象的方法列表" aria-label="Permalink to &quot;uploadTask 对象的方法列表&quot;">​</a></h4><table><thead><tr><th>方法</th><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>abort</td><td></td><td>中断下载任务</td></tr><tr><td>onProgressUpdate</td><td>callback</td><td>监听上传进度变化</td></tr><tr><td>onHeadersReceived</td><td>callback</td><td>监听 HTTP Response Header 事件，会比请求完成事件更早,仅<code>微信小程序平台</code>支持，<a href="https://developers.weixin.qq.com/miniprogram/dev/api/UploadTask.onHeadersReceived.html" target="_blank" rel="noreferrer">规范详情</a></td></tr><tr><td>offProgressUpdate</td><td>callback</td><td>取消监听上传进度变化事件，仅<code>微信小程序平台</code>支持，<a href="https://developers.weixin.qq.com/miniprogram/dev/api/UploadTask.offProgressUpdate.html" target="_blank" rel="noreferrer">规范详情</a></td></tr><tr><td>offHeadersReceived</td><td>callback</td><td>取消监听 HTTP Response Header 事件，仅<code>微信小程序平台</code>支持，<a href="https://developers.weixin.qq.com/miniprogram/dev/api/UploadTask.offHeadersReceived.html" target="_blank" rel="noreferrer">规范详情</a></td></tr></tbody></table><h4 id="onprogressupdate-返回参数说明" tabindex="-1">onProgressUpdate 返回参数说明 <a class="header-anchor" href="#onprogressupdate-返回参数说明" aria-label="Permalink to &quot;onProgressUpdate 返回参数说明&quot;">​</a></h4><table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>progress</td><td><code>Number</code></td><td>上传进度百分比</td></tr><tr><td>totalBytesWritten</td><td><code>Number</code></td><td>已经上传的数据长度，单位 Bytes</td></tr><tr><td>totalBytesExpectedToWrite</td><td><code>Number</code></td><td>预期需要上传的数据总长度，单位 Bytes</td></tr></tbody></table><h2 id="使用示例" tabindex="-1">使用示例 <a class="header-anchor" href="#使用示例" aria-label="Permalink to &quot;使用示例&quot;">​</a></h2><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">uni</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">chooseImage</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">success</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">chooseImageRes</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UniApp</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">ChooseImageSuccessCallbackResult</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tempFilePaths</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">chooseImageRes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tempFilePaths</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">uploadTask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">upload</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            url</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/upload</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 仅为示例，非真实的接口地址</span></span>
<span class="line"><span style="color:#F07178;">            domain</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://www.example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 仅为示例，非真实的服务器域名</span></span>
<span class="line"><span style="color:#F07178;">            filePath</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tempFilePaths</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            name</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            formData</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">success</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">uploadFileRes</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">UniApp</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">UploadFileSuccessCallbackResult</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">uploadFileRes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">uploadTask</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onProgressUpdate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">上传进度</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">progress</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">已经上传的数据长度</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">totalBytesSent</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">预期需要上传的数据总长度</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">totalBytesExpectedToSend</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">// 测试条件，取消上传任务。</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">progress</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">50</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#A6ACCD;">uploadTask</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">abort</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span></code></pre></div>`,15);function u(h,A,C,m,f,b){const n=o("Badge");return e(),p("div",null,[s("h1",d,[l("UPLOAD "),r(n,{type:"tip",text:"已发布"}),l(),F]),y,D,i])}const k=t(c,[["render",u]]);export{_ as __pageData,k as default};
