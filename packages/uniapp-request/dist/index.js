'use strict';

var M=Object.defineProperty,N=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var I=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,n=(r,e)=>{for(var t in e||(e={}))L.call(e,t)&&I(r,t,e[t]);if(v)for(var t of v(e))K.call(e,t)&&I(r,t,e[t]);return r},p=(r,e)=>N(r,$(e));var m=(r,e,t)=>new Promise((a,s)=>{var o=i=>{try{g(t.next(i));}catch(c){s(c);}},u=i=>{try{g(t.throw(i));}catch(c){s(c);}},g=i=>i.done?a(i.value):Promise.resolve(i.value).then(o,u);g((t=t.apply(r,e)).next());});var T=class{constructor(e){this.options=e,this.timeout=(e==null?void 0:e.timeout)||1,this.maxSize=(e==null?void 0:e.maxSize)||5*1024*1024,this.securityToken="",this.accessKeyId="",this.accessKeySecret="",this.uploadDir=(e==null?void 0:e.uploadDir)||"",this.uploadImageUrl=(e==null?void 0:e.uploadImageUrl)||"",this.formData=(e==null?void 0:e.formData)||{},this.getOSSBySTS=()=>e==null?void 0:e.getOSSBySTS(),this.getPolicyBase64=()=>e==null?void 0:e.getPolicyBase64();}getSignature(e,t,a){return m(this,null,function*(){return yield a==null?void 0:a.getSignature(e,t)})}getOSSBySTSInfo(){return m(this,null,function*(){let{access_key_id:e,access_key_secret:t,security_token:a}=yield this.getOSSBySTS();this.accessKeyId=e,this.accessKeySecret=t,this.securityToken=a;})}getUploadParams(){return m(this,null,function*(){let e=this.getPolicyBase64(),t=yield this.getSignature(e,this.accessKeySecret,this.options);return {OSSAccessKeyId:this.accessKeyId,policy:e,signature:t,"x-oss-security-token":this.securityToken}})}uploadFile(e,t){return new Promise((a,s)=>m(this,null,function*(){if(!e){s({code:1,msg:"\u6587\u4EF6\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A",data:void 0});return}let o=t||this.uploadDir;o||s({code:1,msg:"\u4E0A\u4F20\u76EE\u5F55\u4E0D\u80FD\u4E3A\u7A7A",data:void 0}),this.uploadImageUrl||s({code:1,msg:"\u4E0A\u4F20\u670D\u52A1\u5668\u57DF\u540D\u6216\u4E0A\u4F20\u7684\u963F\u91CC\u4E91OSS\u5730\u5740\u4E0D\u80FD\u4E3A\u7A7A",data:void 0});let u=A(e)?e.split(".").pop():"png",g=`${Date.now()}_${Math.floor(Math.random()*1e6)}.${u}`,i=`${this.uploadImageUrl}/${o}/${g}`,c=n(n({key:`${o}/${g}`,success_action_status:200},yield this.getUploadParams()),this.formData),y=uni.uploadFile({url:this.uploadImageUrl,filePath:e,name:"file",formData:n({},c),fail:d=>{if(d.statusCode!==200){s({code:1,msg:"\u4E0A\u4F20\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",data:d.data});return}}});a({code:0,msg:"success",data:{uploadTask:y,url:i,path:`/${o}/${g}`}});}))}},x=T;var E=r=>{var e,t,a,s,o,u,g,i,c,y,d,f,h,b,l,C,S,U,q,R,O,w,D;return {baseUrl:r.baseUrl,debug:(e=r.debug)!=null?e:!1,loading:(t=r.loading)!=null?t:!0,loadingText:(a=r.loadingText)!=null?a:"\u8BF7\u6C42\u4E2D...",before:r.before,after:r.after,header:(s=r.header)!=null?s:{},timeout:(o=r.timeout)!=null?o:6e3,method:(u=r.method)!=null?u:"GET",dataType:(g=r.dataType)!=null?g:"json",responseType:(i=r.responseType)!=null?i:"text",sslVerify:(c=r.sslVerify)!=null?c:!0,withCredentials:(y=r.withCredentials)!=null?y:!1,firstIpv4:(d=r.firstIpv4)!=null?d:!1,errorHandleByCode:r.errorHandleByCode,apiErrorInterception:r.apiErrorInterception,networkExceptionHandle:()=>{},xhrCode:r.xhrCode,xhrCodeName:(f=r.xhrCodeName)!=null?f:"code",requestSuccessResponseMsgName:(h=r.requestSuccessResponseMsgName)!=null?h:"msg",tokenStorageKeyName:(b=r.tokenStorageKeyName)!=null?b:"",taskIdValue:r.taskIdValue,tokenValue:r.tokenValue,buildQueryString:r.buildQueryString,takeTokenMethod:(l=r.takeTokenMethod)!=null?l:"header",takenTokenKeyName:(C=r.takenTokenKeyName)!=null?C:"Authorization",autoRefreshToken:!1,refreshTokenHandle:r.refreshTokenHandle,tokenExpiredCode:(S=r.tokenExpiredCode)!=null?S:403,tokenExpiredCodeType:(U=r.tokenExpiredCodeType)!=null?U:"httpStatusCode",retry:(q=r.retry)!=null?q:!1,retryCount:(R=r.retryCount)!=null?R:3,retryCountAutoOffRetry:(O=r.retryCountAutoOffRetry)!=null?O:!0,retryMaximum:(w=r.retryMaximum)!=null?w:64,retryDeadline:(D=r.retryDeadline)!=null?D:1e4}};var P=r=>{uni.showLoading({title:r.title,mask:r.mask||!0});};var H=r=>typeof r=="object"&&r!==null?Object.keys(r).map(e=>`${e}=${encodeURIComponent(r[e])}`).join("&"):r;function k(r,e,t){let a=(i,c="")=>{t.errorHandleByCode&&t.errorHandleByCode(i,c);};return {request:i=>{var h,b,l;t.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u3011${JSON.stringify(i)}`);let c=(h=e.loading)!=null?h:t.loading,y=(b=e.loadingText)!=null?b:t.loadingText;c&&P({title:y!=null?y:"\u8BF7\u6C42\u4E2D..."}),(l=i==null?void 0:i.header)!=null&&l.contentType&&(i.header["content-type"]=i.header.contentType,delete i.header.contentType);let d="";process.env.NODE_ENV==="development"?d=t.baseUrl.dev:d=t.baseUrl.pro;let f=`${d}${e.url}`;return i.method==="GET"?(i.data=t.buildQueryString&&t.buildQueryString(i.data)?t.buildQueryString(i.data):H(i.data),i.url=`${f}?${i.data}`):i.url=f,e.before&&e.before(i),r.request(i)},response:i=>(a(i.statusCode,i.data[t.requestSuccessResponseMsgName]),t.debug&&console.warn(`\u3010LwuRequest Debug:\u54CD\u5E94\u62E6\u622A\u3011${JSON.stringify(i)}`),e.after&&e.after(i),i),fail:i=>(a(404,i.errMsg),t.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5931\u8D25\u3011${JSON.stringify(i)}`),i),complete:i=>{uni.hideLoading(),t.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210\u3011${JSON.stringify(i)}`);}}}var A=r=>/\.(png|jpeg|jpg|webp|gif)$/i.test(r);var G=(r,e)=>{let t=Math.floor(Math.random()*1e3);return Math.min(Math.pow(2,r)*1e3+t,e)};var B=class{constructor(e){this.currentRequestTask={abort:()=>{},onHeadersReceived:()=>{},offHeadersReceived:()=>{}};this.requestTasksName="LWU-REQUEST-TASKS";this.lock=!0;this.pending=[];this.retryCount=3;this.retryMaximum=64;this.retryTimeout=[];this.retryDeadline=1e4;this.globalConfig={baseUrl:{pro:"",dev:""},errorHandleByCode:(e,t)=>{},apiErrorInterception:e=>{}};this.reqConfig={};if(this.globalConfig=n({},E(e)),this.reqConfig=n({task_id:"",domain:""},this.globalConfig),!this.globalConfig.retry)this.retryCount=0;else if(this.globalConfig.retryCountAutoOffRetry){this.retryMaximum=this.globalConfig.retryMaximum*1e3,this.retryTimeout=[],this.retryDeadline=e.retryDeadline;for(let t=0;t<this.retryCount&&!(this.retryDeadline<0);t++){let a=G(t,this.retryMaximum);this.retryDeadline-=a,this.retryTimeout.push(a);}this.retryCount=this.retryTimeout.length;}}handleError(e,t=""){this.globalConfig.errorHandleByCode&&this.globalConfig.errorHandleByCode(e,t);}refreshToken(){this.globalConfig.refreshTokenHandle&&this.globalConfig.refreshTokenHandle().then(()=>{uni.getStorageSync("LWU-REQUEST-CALLBACK")(e=>{e();});}).catch(()=>{this.handleError(this.globalConfig.tokenExpiredCode);});}beforeRequest(){return m(this,arguments,function*(e={},t){var o,u;let a=uni.getStorageSync(this.requestTasksName),s=(o=t==null?void 0:t.task_id)!=null?o:"";return this.globalConfig.taskIdValue&&(s=yield this.globalConfig.taskIdValue(e,t)),s&&a[s]&&(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42ID${s}\u6709\u91CD\u590D\u9879\u5DF2\u81EA\u52A8\u8FC7\u6EE4`),(u=a[s])==null||u.abort()),new Promise((g,i)=>m(this,null,function*(){let c=uni.getStorageSync(this.globalConfig.tokenStorageKeyName);(()=>new Promise((d,f)=>{c&&d(c),this.globalConfig.tokenValue?this.globalConfig.tokenValue().then(h=>{h&&d(h),d(!1);}):d(!0);}))().then(d=>{var f,h;d&&t&&(this.globalConfig.takeTokenMethod==="header"&&(t.header=(f=t.header)!=null?f:{},t.header[(h=this.globalConfig)==null?void 0:h.takenTokenKeyName]=d),this.globalConfig.takeTokenMethod==="body"&&(e[this.globalConfig.takenTokenKeyName]=d)),g(!0);});}))})}request(e,t={},a){let s=n(n({},this.reqConfig),a);return new Promise((o,u)=>{var g,i,c,y;this.beforeRequest&&this.beforeRequest(t,p(n({},s),{baseUrl:{dev:(i=s.domain)!=null?i:(g=this.globalConfig)==null?void 0:g.baseUrl.dev,pro:(y=s.domain)!=null?y:(c=this.globalConfig)==null?void 0:c.baseUrl.pro}})).then(()=>m(this,null,function*(){var h,b;let d=k({request:l=>(e=l.url,s=p(n(n({},this.reqConfig),l),{header:n(n({},this.reqConfig.header),l==null?void 0:l.header)}),l),response:l=>l,fail:l=>(u(l),l)},n({url:e},s),p(n({},this.globalConfig),{baseUrl:{dev:s.domain||this.globalConfig.baseUrl.dev,pro:s.domain||this.globalConfig.baseUrl.pro}}));d.request({header:n({},a==null?void 0:a.header),method:(h=a==null?void 0:a.method)!=null?h:"GET",data:t,url:e}),this.currentRequestTask=uni.request({url:e,data:t,header:n({},s.header),method:s.method,timeout:s.timeout,dataType:s.dataType,responseType:s.responseType,sslVerify:s.sslVerify,withCredentials:s.withCredentials,firstIpv4:s.firstIpv4,success:l=>{var S;d.response(l),typeof this.globalConfig.xhrCode=="undefined"?this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(l.data,l):this.globalConfig.xhrCodeName&&l.data[this.globalConfig.xhrCodeName]&&l.data[this.globalConfig.xhrCodeName]!==this.globalConfig.xhrCode&&(this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(l.data,l),u(l));let C=l.statusCode;((S=this.globalConfig)==null?void 0:S.tokenExpiredCodeType)==="apiResponseCode"&&this.globalConfig.tokenExpiredCode&&(C=this.globalConfig.tokenExpiredCode),C!==this.globalConfig.tokenExpiredCode?o(l.data):(this.refreshToken(),uni.setStorageSync("LWU-REQUEST-CALLBACK",()=>{o(this.request(e,t,s));}));},fail:l=>{var C;d.fail(l),u(l),this.retryCount=(C=s.retryCount)!=null?C:3,this.retryCount&&(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u81EA\u52A8\u91CD\u8BD5\u6B21\u6570\uFF1A${this.retryCount}`),this.retryCount--,setTimeout(this.request,this.retryTimeout.shift()),this.globalConfig.networkExceptionHandle&&this.globalConfig.networkExceptionHandle());},complete:l=>{d.complete(l);}});let f=(b=s==null?void 0:s.task_id)!=null?b:"";if(this.globalConfig.taskIdValue&&(f=yield this.globalConfig.taskIdValue(t,a)),f){let l=[];l[f]=this.currentRequestTask,uni.setStorageSync(this.requestTasksName,l);}}));})}get(e,t={},a={}){return this.request(e,t,n({method:"GET"},a))}post(e,t={},a={}){return this.request(e,t,n({method:"POST"},a))}put(e,t={},a={}){return this.request(e,t,n({method:"PUT"},a))}delete(e,t={},a={}){return this.request(e,t,n({method:"DELETE"},a))}config(e={}){return this.reqConfig=n(n({},this.reqConfig),e),this}setHeader(e){return this.reqConfig.header=n({},e),this}abort(e=""){let t=uni.getStorageSync(this.requestTasksName);t[e]?t[e].abort():this.currentRequestTask.abort();}download(e){var o;let t=p(n(n({},this.reqConfig),e),{method:"DOWNLOAD"}),a=k({request:u=>(e.url=u.url,u),response:u=>u},n({},t),this.globalConfig),s=n({contentType:""},t==null?void 0:t.header);return a.request({header:s,method:"DOWNLOAD",data:"",url:e.url}),uni.downloadFile({url:e.url,header:s,timeout:(o=t.timeout)!=null?o:6e4,filePath:t.filePath,success:u=>{a.response(p(n({},u),{data:"",header:{},cookies:[]})),e.success&&e.success(u);},fail:u=>{a.fail(u),e.fail&&e.fail(u);},complete:u=>{a.complete(u),e.complete&&e.complete(u);}})}upload(e){let t=p(n(n({},this.reqConfig),e),{method:"UPLOAD"}),a=k({request:o=>(e.url=o.url,o),response:o=>o},n({},t),this.globalConfig),s=n({contentType:""},t==null?void 0:t.header);return a.request({header:s,method:"UPLOAD",data:"",url:e.url}),uni.uploadFile({url:e.url,files:e.files,fileType:e.fileType,file:e.file,filePath:e.filePath,name:e.name,header:s,timeout:e.timeout,formData:e.formData,success:o=>{a.response(p(n({},o),{data:"",header:{},cookies:[]})),e.success&&e.success(o);},fail:o=>{a.fail(o),e.fail&&e.fail(o);},complete:o=>{a.complete(o),e.complete&&e.complete(o);}})}uploadAliossSync(e){return m(this,null,function*(){let t=new x({filePath:e.filePath,uploadDir:e.uploadDir,maxSize:e.maxSize,uploadImageUrl:e.uploadImageUrl,getOSSBySTS:e.getOSSBySTS,getPolicyBase64:e.getPolicyBase64,getSignature:e.getSignature});return yield t.getOSSBySTSInfo(),yield t.uploadFile(e.filePath,e.uploadDir)})}uploadAlioss(e){let t=new x({filePath:e.filePath,uploadDir:e.uploadDir,maxSize:e.maxSize,uploadImageUrl:e.uploadImageUrl,getOSSBySTS:e.getOSSBySTS,getPolicyBase64:e.getPolicyBase64,getSignature:e.getSignature});t.getOSSBySTSInfo().then(()=>t.uploadFile(e.filePath,e.uploadDir));}};

exports.Http = B;
