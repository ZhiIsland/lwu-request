'use strict';

var B=Object.defineProperty,_=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var v=(r,e,t)=>e in r?B(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,n=(r,e)=>{for(var t in e||(e={}))L.call(e,t)&&v(r,t,e[t]);if(I)for(var t of I(e))H.call(e,t)&&v(r,t,e[t]);return r},T=(r,e)=>_(r,$(e));var p=(r,e,t)=>new Promise((s,u)=>{var i=a=>{try{d(t.next(a));}catch(h){u(h);}},o=a=>{try{d(t.throw(a));}catch(h){u(h);}},d=a=>a.done?s(a.value):Promise.resolve(a.value).then(i,o);d((t=t.apply(r,e)).next());});var R=class{constructor(e){this.options=e,this.timeout=(e==null?void 0:e.timeout)||1,this.maxSize=(e==null?void 0:e.maxSize)||5*1024*1024,this.securityToken="",this.accessKeyId="",this.accessKeySecret="",this.uploadDir=(e==null?void 0:e.uploadDir)||"",this.uploadImageUrl=(e==null?void 0:e.uploadImageUrl)||"",this.formData=(e==null?void 0:e.formData)||{},this.getOSSBySTS=()=>e==null?void 0:e.getOSSBySTS(),this.getPolicyBase64=()=>e==null?void 0:e.getPolicyBase64();}getSignature(e,t,s){return p(this,null,function*(){return yield s==null?void 0:s.getSignature(e,t)})}getOSSBySTSInfo(){return p(this,null,function*(){let{access_key_id:e,access_key_secret:t,security_token:s}=yield this.getOSSBySTS();this.accessKeyId=e,this.accessKeySecret=t,this.securityToken=s;})}getUploadParams(){return p(this,null,function*(){let e=this.getPolicyBase64(),t=yield this.getSignature(e,this.accessKeySecret,this.options);return {OSSAccessKeyId:this.accessKeyId,policy:e,signature:t,"x-oss-security-token":this.securityToken}})}uploadFile(e,t){return new Promise((s,u)=>p(this,null,function*(){if(!e){u({code:1,msg:"\u6587\u4EF6\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A",data:void 0});return}let i=t||this.uploadDir;i||u({code:1,msg:"\u4E0A\u4F20\u76EE\u5F55\u4E0D\u80FD\u4E3A\u7A7A",data:void 0}),this.uploadImageUrl||u({code:1,msg:"\u4E0A\u4F20\u670D\u52A1\u5668\u57DF\u540D\u6216\u4E0A\u4F20\u7684\u963F\u91CC\u4E91OSS\u5730\u5740\u4E0D\u80FD\u4E3A\u7A7A",data:void 0});let o=N(e)?e.split(".").pop():"png",d=`${Date.now()}_${Math.floor(Math.random()*1e6)}.${o}`,a=`${this.uploadImageUrl}/${i}/${d}`,h=n(n({key:`${i}/${d}`,success_action_status:200},yield this.getUploadParams()),this.formData),y=uni.uploadFile({url:this.uploadImageUrl,filePath:e,name:"file",formData:n({},h),fail:c=>{if(c.statusCode!==200){u({code:1,msg:"\u4E0A\u4F20\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",data:c.data});return}}});s({code:0,msg:"success",data:{uploadTask:y,url:a,path:`/${i}/${d}`}});}))}},q=R;var P=r=>{var e,t,s,u,i,o,d,a,h,y,c,m,g,b,f,l,C,k,S,U,w,D,E;return {baseUrl:r.baseUrl,debug:(e=r.debug)!=null?e:!1,loading:(t=r.loading)!=null?t:!0,loadingText:(s=r.loadingText)!=null?s:"\u8BF7\u6C42\u4E2D...",before:r.before,after:r.after,header:(u=r.header)!=null?u:{},timeout:(i=r.timeout)!=null?i:6e3,method:(o=r.method)!=null?o:"GET",dataType:(d=r.dataType)!=null?d:"json",responseType:(a=r.responseType)!=null?a:"text",sslVerify:(h=r.sslVerify)!=null?h:!0,withCredentials:(y=r.withCredentials)!=null?y:!1,firstIpv4:(c=r.firstIpv4)!=null?c:!1,errorHandleByCode:r.errorHandleByCode,apiErrorInterception:r.apiErrorInterception,networkExceptionHandle:()=>{},xhrCode:r.xhrCode,xhrCodeName:(m=r.xhrCodeName)!=null?m:"code",requestSuccessResponseMsgName:(g=r.requestSuccessResponseMsgName)!=null?g:"msg",tokenStorageKeyName:(b=r.tokenStorageKeyName)!=null?b:"",taskIdValue:r.taskIdValue,tokenValue:r.tokenValue,buildQueryString:r.buildQueryString,takeTokenMethod:(f=r.takeTokenMethod)!=null?f:"header",takenTokenKeyName:(l=r.takenTokenKeyName)!=null?l:"Authorization",autoRefreshToken:!1,refreshTokenHandle:r.refreshTokenHandle,tokenExpiredCode:(C=r.tokenExpiredCode)!=null?C:403,tokenExpiredCodeType:(k=r.tokenExpiredCodeType)!=null?k:"httpStatusCode",retry:(S=r.retry)!=null?S:!1,retryCount:(U=r.retryCount)!=null?U:3,retryCountAutoOffRetry:(w=r.retryCountAutoOffRetry)!=null?w:!0,retryMaximum:(D=r.retryMaximum)!=null?D:64,retryDeadline:(E=r.retryDeadline)!=null?E:1e4}},O=r=>{var e,t,s,u,i,o,d,a;return {task_id:(e=r.task_id)!=null?e:"",before:r.before,after:r.after,header:r.header,method:(t=r.method)!=null?t:"GET",timeout:(s=r.timeout)!=null?s:6e3,dataType:(u=r.dataType)!=null?u:"json",responseType:(i=r.responseType)!=null?i:"text",sslVerify:r.sslVerify||!1,withCredentials:r.withCredentials||!1,firstIpv4:r.firstIpv4||!1,retryCount:(o=r.retryCount)!=null?o:3,loading:r.loading||!0,loadingText:(d=r.loadingText)!=null?d:"\u8BF7\u6C42\u4E2D...",domain:(a=r.domain)!=null?a:"",autoTakeToken:r.autoTakeToken||!0}};var A=r=>{uni.showLoading({title:r.title,mask:r.mask||!0});};var j=r=>typeof r=="object"&&r!==null?Object.keys(r).map(e=>`${e}=${encodeURIComponent(r[e])}`).join("&"):r;function x(r,e,t){let s=(a,h="")=>{t.errorHandleByCode&&t.errorHandleByCode(a,h);};return {request:a=>{var g,b,f,l,C;t.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42\u62E6\u622A:${JSON.stringify(a)}`);let h=(g=e.loading)!=null?g:t.loading,y=(b=e.loadingText)!=null?b:t.loadingText;h&&A({title:y!=null?y:"\u8BF7\u6C42\u4E2D..."}),(f=a==null?void 0:a.header)!=null&&f.contentType&&(a.header["content-type"]=a.header.contentType,delete a.header.contentType);let c="";process.env.NODE_ENV==="development"?c=t.baseUrl.dev:c=t.baseUrl.pro;let m=`${c}${e.url}`;return e.url&&(((l=e.url)==null?void 0:l.indexOf("http://"))>-1||((C=e.url)==null?void 0:C.indexOf("https://"))>-1)&&(m=e.url),a.method==="GET"?(a.data=t.buildQueryString&&t.buildQueryString(a.data)?t.buildQueryString(a.data):j(a.data),a.url=`${m}?${a.data}`):a.url=m,e.before&&e.before(a),r.request(a)},response:a=>(s(a.statusCode,a.data[t.requestSuccessResponseMsgName]),t.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u54CD\u5E94\u62E6\u622A:${JSON.stringify(a)}`),e.after&&e.after(a),a),fail:a=>(a.errMsg==="request:fail"?s(1009,a.errMsg):a.errMsg==="request:fail timeout"?s(408,a.errMsg):s(404,a.errMsg),t.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42\u62E6\u622A\u5931\u8D25:${JSON.stringify(a)}`),a),complete:a=>{uni.hideLoading(),a.errMsg==="request:fail"&&t.networkExceptionHandle&&t.networkExceptionHandle(),t.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210:${JSON.stringify(a)}`);}}}var N=r=>/\.(png|jpeg|jpg|webp|gif)$/i.test(r);var F=(r,e)=>{let t=Math.floor(Math.random()*1e3);return Math.min(Math.pow(2,r)*1e3+t,e)};var M=class{constructor(e){this.currentRequestTask={abort:()=>{},onHeadersReceived:()=>{},offHeadersReceived:()=>{}};this.requestTasksName="LWU-REQUEST-TASKS";this.lock=!0;this.pending=[];this.retryCount=3;this.retryMaximum=64;this.retryTimeout=[];this.retryDeadline=1e4;this.globalConfig={baseUrl:{pro:"",dev:""},errorHandleByCode:(e,t)=>{},apiErrorInterception:e=>{}};this.reqConfig={};if(this.globalConfig=n({},P(e)),this.reqConfig=n({task_id:"",domain:""},this.globalConfig),!this.globalConfig.retry)this.retryCount=0;else if(this.globalConfig.retryCountAutoOffRetry){this.retryMaximum=this.globalConfig.retryMaximum*1e3,this.retryTimeout=[],this.retryDeadline=e.retryDeadline;for(let t=0;t<this.retryCount&&!(this.retryDeadline<0);t++){let s=F(t,this.retryMaximum);this.retryDeadline-=s,this.retryTimeout.push(s);}this.retryCount=this.retryTimeout.length;}}handleError(e,t=""){this.globalConfig.errorHandleByCode&&this.globalConfig.errorHandleByCode(e,t);}refreshToken(){this.globalConfig.refreshTokenHandle&&this.globalConfig.refreshTokenHandle().then(()=>{uni.getStorageSync("LWU-REQUEST-CALLBACK")(e=>{e();});}).catch(()=>{this.handleError(this.globalConfig.tokenExpiredCode);});}beforeRequest(){return p(this,arguments,function*(e={},t,s=null,u=""){var d,a;let i=uni.getStorageSync(this.requestTasksName),o=(d=t==null?void 0:t.task_id)!=null?d:"";return this.globalConfig.taskIdValue&&(o=yield this.globalConfig.taskIdValue(e,t)),o&&i[o]&&(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42ID${o}\u6709\u91CD\u590D\u9879\u5DF2\u81EA\u52A8\u8FC7\u6EE4`),(a=i[o])==null||a.abort()),new Promise((h,y)=>p(this,null,function*(){let c=uni.getStorageSync(this.globalConfig.tokenStorageKeyName);(()=>new Promise((g,b)=>p(this,null,function*(){c&&g(c);let f="";this.globalConfig.tokenValue&&(f=yield this.globalConfig.tokenValue()),s&&this.globalConfig.refreshTokenHandle?this.globalConfig.refreshTokenHandle(f).then(l=>{l&&g(l),g(!1);}):this.globalConfig.tokenValue?this.globalConfig.tokenValue().then(l=>{l&&g(l),g(!1);}):g(!0);})))().then(g=>{var b,f;typeof g=="string"&&t&&t.autoTakeToken&&(this.globalConfig.takeTokenMethod==="header"&&(t.header=(b=t.header)!=null?b:{},t.header[(f=this.globalConfig)==null?void 0:f.takenTokenKeyName]=g),this.globalConfig.takeTokenMethod==="body"&&(e[this.globalConfig.takenTokenKeyName]=g)),h(!0);});}))})}request(e,t={},s,u=null){let i=n(n({autoTakeToken:s.autoTakeToken||O(s).autoTakeToken},this.reqConfig),s);return new Promise((o,d)=>{var a,h,y,c;this.beforeRequest&&this.beforeRequest(t,T(n({},i),{baseUrl:{dev:(h=i.domain)!=null?h:(a=this.globalConfig)==null?void 0:a.baseUrl.dev,pro:(c=i.domain)!=null?c:(y=this.globalConfig)==null?void 0:y.baseUrl.pro}}),u,e).then(()=>p(this,null,function*(){var b,f;let m=x({request:l=>(e=l.url,i=T(n(n({},this.reqConfig),l),{header:n(n({},this.reqConfig.header),l==null?void 0:l.header)}),l),response:l=>l,fail:l=>(d(l),l)},n({url:e},i),T(n({},this.globalConfig),{baseUrl:{dev:i.domain||this.globalConfig.baseUrl.dev,pro:i.domain||this.globalConfig.baseUrl.pro}}));m.request({header:n({},i.header),method:(b=s==null?void 0:s.method)!=null?b:"GET",data:t,url:e}),this.currentRequestTask=uni.request({url:e,data:t,header:n({},i.header),method:i.method,timeout:i.timeout,dataType:i.dataType,responseType:i.responseType,sslVerify:i.sslVerify,withCredentials:i.withCredentials,firstIpv4:i.firstIpv4,success:l=>{var k;m.response(l),typeof this.globalConfig.xhrCode=="undefined"?this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(l.data,l):this.globalConfig.xhrCodeName&&l.data[this.globalConfig.xhrCodeName]!=="undefined"&&l.data[this.globalConfig.xhrCodeName]!==this.globalConfig.xhrCode&&(this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(l.data,l),d(l));let C=l.statusCode;if(((k=this.globalConfig)==null?void 0:k.tokenExpiredCodeType)==="apiResponseCode"&&typeof this.globalConfig.tokenExpiredCode!==void 0&&this.globalConfig.xhrCodeName&&(C=l.data[this.globalConfig.xhrCodeName]),u){this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011token\u5931\u6548\u4E8C\u6B21\u8BF7\u6C42\u6210\u529F\u54CD\u5E94:${JSON.stringify(l.data)}`),u(l.data);return}C!==this.globalConfig.tokenExpiredCode?o(l.data):(this.globalConfig.debug&&console.warn("\u3010LwuRequest Debug\u3011token\u5931\u6548\uFF0C\u5F00\u59CB\u6267\u884C\u5237\u65B0token\u7A0B\u5E8F"),this.globalConfig.refreshTokenHandle&&this.globalConfig.refreshTokenHandle().then(S=>{this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u65B0\u7684token:${S}`),this.globalConfig.debug&&console.warn("\u3010LwuRequest Debug\u3011\u81EA\u52A8\u5237\u65B0token\u5B8C\u6210\uFF0C\u5F00\u59CB\u91CD\u65B0\u53D1\u8D77\u8BF7\u6C42"),this.request(e,t,i,o);}));},fail:l=>{var C;m.fail(l),this.retryCount=(C=i.retryCount)!=null?C:3,this.retryCount&&(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u81EA\u52A8\u91CD\u8BD5\u6B21\u6570:${this.retryCount}`),this.retryCount--,setTimeout(this.request,this.retryTimeout.shift()),this.globalConfig.networkExceptionHandle&&this.globalConfig.networkExceptionHandle()),d(l);},complete:l=>{m.complete(l);}});let g=(f=i==null?void 0:i.task_id)!=null?f:"";if(this.globalConfig.taskIdValue&&(g=yield this.globalConfig.taskIdValue(t,s)),g){let l=[];l[g]=this.currentRequestTask,uni.setStorageSync(this.requestTasksName,l);}}));})}get(e,t={},s={}){return this.request(e,t,n({method:"GET"},s))}post(e,t={},s={}){return this.request(e,t,n({method:"POST"},s))}put(e,t={},s={}){return this.request(e,t,n({method:"PUT"},s))}delete(e,t={},s={}){return this.request(e,t,n({method:"DELETE"},s))}config(e={}){return this.reqConfig=n(T(n({},this.globalConfig),{autoTakeToken:e.autoTakeToken||O(e).autoTakeToken}),e),this}uri(){let e=this.reqConfig.domain||this.globalConfig.baseUrl.pro;return process.env.NODE_ENV==="development"&&(e=this.reqConfig.domain||this.globalConfig.baseUrl.dev),e}setHeader(e){return this.reqConfig.header=n({},e),this}abort(e=""){let t=uni.getStorageSync(this.requestTasksName);t[e]?t[e].abort():this.currentRequestTask.abort();}download(e){var i;let t=T(n(n({},this.reqConfig),e),{method:"DOWNLOAD"}),s=x({request:o=>(e.url=o.url,o),response:o=>o},n({},t),this.globalConfig),u=n({contentType:""},t==null?void 0:t.header);return s.request({header:u,method:"DOWNLOAD",data:"",url:e.url}),uni.downloadFile({url:e.url,header:u,timeout:(i=t.timeout)!=null?i:6e4,filePath:t.filePath,success:o=>{s.response(T(n({},o),{data:"",header:{},cookies:[]})),e.success&&e.success(o);},fail:o=>{s.fail(o),e.fail&&e.fail(o);},complete:o=>{s.complete(o),e.complete&&e.complete(o);}})}upload(e){let t=T(n(n({},this.reqConfig),e),{method:"UPLOAD"}),s=x({request:i=>(e.url=i.url,i),response:i=>i},n({},t),this.globalConfig),u=n({contentType:""},t==null?void 0:t.header);return s.request({header:u,method:"UPLOAD",data:"",url:e.url}),uni.uploadFile({url:e.url,files:e.files,fileType:e.fileType,file:e.file,filePath:e.filePath,name:e.name,header:u,timeout:e.timeout,formData:e.formData,success:i=>{s.response(T(n({},i),{data:"",header:{},cookies:[]})),e.success&&e.success(i);},fail:i=>{s.fail(i),e.fail&&e.fail(i);},complete:i=>{s.complete(i),e.complete&&e.complete(i);}})}uploadAliossSync(e){return p(this,null,function*(){let t=new q({filePath:e.filePath,uploadDir:e.uploadDir,maxSize:e.maxSize,uploadImageUrl:e.uploadImageUrl,getOSSBySTS:e.getOSSBySTS,getPolicyBase64:e.getPolicyBase64,getSignature:e.getSignature});return yield t.getOSSBySTSInfo(),yield t.uploadFile(e.filePath,e.uploadDir)})}uploadAlioss(e){let t=new q({filePath:e.filePath,uploadDir:e.uploadDir,maxSize:e.maxSize,uploadImageUrl:e.uploadImageUrl,getOSSBySTS:e.getOSSBySTS,getPolicyBase64:e.getPolicyBase64,getSignature:e.getSignature});t.getOSSBySTSInfo().then(()=>t.uploadFile(e.filePath,e.uploadDir));}};

exports.Http = M;
