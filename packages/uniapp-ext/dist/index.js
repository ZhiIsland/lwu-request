'use strict';

var U=Object.defineProperty;var R=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var x=(n,t,e)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,f=(n,t)=>{for(var e in t||(t={}))M.call(t,e)&&x(n,e,t[e]);if(R)for(var e of R(t))A.call(t,e)&&x(n,e,t[e]);return n};var q=(n,t,e)=>new Promise((r,u)=>{var d=s=>{try{l(e.next(s));}catch(a){u(a);}},c=s=>{try{l(e.throw(s));}catch(a){u(a);}},l=s=>s.done?r(s.value):Promise.resolve(s.value).then(d,c);l((e=e.apply(n,t)).next());});var S=n=>{var t,e,r,u,d,c,l,s,a,m,h,i,g,y,o,b,T,k,p,C;return {baseUrl:n.baseUrl,debug:(t=n.debug)!=null?t:!1,loading:(e=n.loading)!=null?e:!0,loadingText:(r=n.loadingText)!=null?r:"\u8BF7\u6C42\u4E2D...",timeout:(u=n.timeout)!=null?u:6e3,method:(d=n.method)!=null?d:"GET",dataType:(c=n.dataType)!=null?c:"json",responseType:(l=n.responseType)!=null?l:"text",sslVerify:(s=n.sslVerify)!=null?s:!0,withCredentials:(a=n.withCredentials)!=null?a:!1,firstIpv4:(m=n.firstIpv4)!=null?m:!1,errorHandleByCode:n.errorHandleByCode,apiErrorInterception:n.apiErrorInterception,networkExceptionHandle:()=>{},requestSuccessResponseMsgName:(h=n.requestSuccessResponseMsgName)!=null?h:"msg",tokenStorageKeyName:(i=n.tokenStorageKeyName)!=null?i:"",tokenValue:n.tokenValue,buildQueryString:n.buildQueryString,takeTokenMethod:(g=n.takeTokenMethod)!=null?g:"header",takenTokenKeyName:(y=n.takenTokenKeyName)!=null?y:"Authorization",autoRefreshToken:!1,refreshTokenHandle:n.refreshTokenHandle,tokenExpiredCode:(o=n.tokenExpiredCode)!=null?o:403,retry:(b=n.retry)!=null?b:!1,retryCount:(T=n.retryCount)!=null?T:3,retryCountAutoOffRetry:(k=n.retryCountAutoOffRetry)!=null?k:!0,retryMaximum:(p=n.retryMaximum)!=null?p:64,retryDeadline:(C=n.retryDeadline)!=null?C:1e4}};var w=n=>{uni.showLoading({title:n.title,mask:n.mask||!0});};var N=n=>typeof n=="object"&&n!==null?Object.keys(n).map(t=>`${t}=${encodeURIComponent(n[t])}`).join("&"):n;function E(n,t,e){let r=(s,a="")=>{e.errorHandleByCode&&e.errorHandleByCode(s,a);};return {request:s=>{var h,i;e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u3011${JSON.stringify(s)}`),e.loading&&w({title:(h=e.loadingText)!=null?h:"\u8BF7\u6C42\u4E2D..."}),(i=s==null?void 0:s.header)!=null&&i.contentType&&(s.header["content-type"]=s.header.contentType,delete s.header.contentType);let a="";process.env.NODE_ENV==="development"?a=e.baseUrl.dev:a=e.baseUrl.pro;let m=`${a}${t.url}`;return s.method==="GET"?(s.data=e.buildQueryString&&e.buildQueryString(s.data)?e.buildQueryString(s.data):N(s.data),s.url=`${m}?${s.data}`):s.url=m,t.before&&t.before(),n.request(s)},response:s=>(r(s.statusCode,s.data[e.requestSuccessResponseMsgName]),e.apiErrorInterception&&e.apiErrorInterception(s.data,s),e.debug&&console.warn(`\u3010LwuRequest Debug:\u54CD\u5E94\u62E6\u622A\u3011${JSON.stringify(s)}`),t.after&&t.after(),s),fail:s=>(e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5931\u8D25\u3011${JSON.stringify(s)}`),s),complete:s=>{uni.hideLoading(),e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210\u3011${JSON.stringify(s)}`);}}}var O=(n,t)=>{let e=Math.floor(Math.random()*1e3);return Math.min(Math.pow(2,n)*1e3+e,t)};var v=class{constructor(t){this.currentRequestTask={abort:()=>{},onHeadersReceived:()=>{},offHeadersReceived:()=>{}};this.requestTasksName="LWU-REQUEST-TASKS";this.lock=!0;this.pending=[];this.retryCount=3;this.retryMaximum=64;this.retryTimeout=[];this.retryDeadline=1e4;this.config={baseUrl:{pro:"",dev:""},errorHandleByCode:(t,e)=>{},apiErrorInterception:t=>{}};if(this.config=f({},S(t)),!this.config.retry)this.retryCount=0;else if(this.config.retryCountAutoOffRetry){this.retryMaximum=this.config.retryMaximum*1e3,this.retryTimeout=[],this.retryDeadline=t.retryDeadline;for(let e=0;e<this.retryCount&&!(this.retryDeadline<0);e++){let r=O(e,this.retryMaximum);this.retryDeadline-=r,this.retryTimeout.push(r);}this.retryCount=this.retryTimeout.length;}}handleError(t,e=""){this.config.errorHandleByCode&&this.config.errorHandleByCode(t,e);}refreshToken(){this.config.refreshTokenHandle&&this.config.refreshTokenHandle().then(()=>{uni.getStorageSync("LWU-REQUEST-CALLBACK")(t=>{t();});}).catch(()=>{this.handleError(this.config.tokenExpiredCode);});}request(t,e={},r={header:{},method:this.config.method,timeout:this.config.timeout,dataType:this.config.dataType,responseType:this.config.responseType,sslVerify:this.config.sslVerify,withCredentials:this.config.withCredentials,firstIpv4:this.config.firstIpv4,retryCount:this.config.retryCount}){var d;let u=uni.getStorageSync(this.requestTasksName);return r!=null&&r.task_id&&u[r==null?void 0:r.task_id]&&(this.config.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42ID${r.task_id}\u6709\u91CD\u590D\u9879\u5DF2\u81EA\u52A8\u8FC7\u6EE4`),(d=u[r==null?void 0:r.task_id])==null||d.abort()),new Promise((c,l)=>q(this,null,function*(){var h;let s=E({request:i=>(t=i.url,i),response:i=>{}},{url:t,before:r.before,after:r.after,header:r.header},this.config);s.request({header:f({contentType:""},r.header),method:(h=r.method)!=null?h:"GET",data:e,url:t});let a=uni.getStorageSync(this.config.tokenStorageKeyName);(()=>new Promise((i,g)=>{a&&i(a),this.config.tokenValue?this.config.tokenValue().then(y=>{y&&i(y),i(!1);}):i("");}))().then(i=>{var g,y;if(i&&(this.config.takeTokenMethod==="header"&&(r.header=(g=r.header)!=null?g:{},r.header[(y=this.config)==null?void 0:y.takenTokenKeyName]=i),this.config.takeTokenMethod==="body"&&(e[this.config.takenTokenKeyName]=i)),this.currentRequestTask=uni.request({url:t,data:e,header:f({},r.header),method:r.method,timeout:r.timeout,dataType:r.dataType,responseType:r.responseType,sslVerify:r.sslVerify,withCredentials:r.withCredentials,firstIpv4:r.firstIpv4,success:o=>{s.response(o),o.statusCode!==this.config.tokenExpiredCode?c(o.data):(this.refreshToken(),uni.setStorageSync("LWU-REQUEST-CALLBACK",()=>{c(this.request(t,e,r));}));},fail:o=>{var b;s.fail(o),this.retryCount=(b=r.retryCount)!=null?b:3,this.retryCount===0?l(o):(this.config.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u81EA\u52A8\u91CD\u8BD5\u6B21\u6570\uFF1A${this.retryCount}`),this.retryCount--,setTimeout(this.request,this.retryTimeout.shift()),this.config.networkExceptionHandle&&this.config.networkExceptionHandle());},complete:o=>{s.complete(o);}}),r!=null&&r.task_id){let o=[];o[r==null?void 0:r.task_id]=this.currentRequestTask,uni.setStorageSync(this.requestTasksName,o);}});}))}get(t,e={},r={}){return this.request(t,e,f({method:"GET"},r))}post(t,e={},r={}){return this.request(t,e,f({method:"POST"},r))}put(t,e={},r={}){return this.request(t,e,f({method:"POST"},r))}delete(t,e={},r={}){return this.request(t,e,f({method:"DELETE"},r))}abort(t=""){let e=uni.getStorageSync(this.requestTasksName);e[t]?e[t].abort():this.currentRequestTask.abort();}};

exports.Http = v;
