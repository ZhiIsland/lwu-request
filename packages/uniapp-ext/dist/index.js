'use strict';

var N=Object.defineProperty;var R=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var q=(t,r,e)=>r in t?N(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,f=(t,r)=>{for(var e in r||(r={}))M.call(r,e)&&q(t,e,r[e]);if(R)for(var e of R(r))A.call(r,e)&&q(t,e,r[e]);return t};var S=(t,r,e)=>new Promise((n,l)=>{var d=i=>{try{u(e.next(i));}catch(o){l(o);}},c=i=>{try{u(e.throw(i));}catch(o){l(o);}},u=i=>i.done?n(i.value):Promise.resolve(i.value).then(d,c);u((e=e.apply(t,r)).next());});var w=t=>{var r,e,n,l,d,c,u,i,o,m,h,a,g,y,s,b,T,C,k,p,x;return {baseUrl:t.baseUrl,debug:(r=t.debug)!=null?r:!1,loading:(e=t.loading)!=null?e:!0,loadingText:(n=t.loadingText)!=null?n:"\u8BF7\u6C42\u4E2D...",timeout:(l=t.timeout)!=null?l:6e3,method:(d=t.method)!=null?d:"GET",dataType:(c=t.dataType)!=null?c:"json",responseType:(u=t.responseType)!=null?u:"text",sslVerify:(i=t.sslVerify)!=null?i:!0,withCredentials:(o=t.withCredentials)!=null?o:!1,firstIpv4:(m=t.firstIpv4)!=null?m:!1,errorHandleByCode:t.errorHandleByCode,apiErrorInterception:t.apiErrorInterception,networkExceptionHandle:()=>{},xhrCode:t.xhrCode,xhrCodeName:(h=t.xhrCodeName)!=null?h:"code",requestSuccessResponseMsgName:(a=t.requestSuccessResponseMsgName)!=null?a:"msg",tokenStorageKeyName:(g=t.tokenStorageKeyName)!=null?g:"",tokenValue:t.tokenValue,buildQueryString:t.buildQueryString,takeTokenMethod:(y=t.takeTokenMethod)!=null?y:"header",takenTokenKeyName:(s=t.takenTokenKeyName)!=null?s:"Authorization",autoRefreshToken:!1,refreshTokenHandle:t.refreshTokenHandle,tokenExpiredCode:(b=t.tokenExpiredCode)!=null?b:403,retry:(T=t.retry)!=null?T:!1,retryCount:(C=t.retryCount)!=null?C:3,retryCountAutoOffRetry:(k=t.retryCountAutoOffRetry)!=null?k:!0,retryMaximum:(p=t.retryMaximum)!=null?p:64,retryDeadline:(x=t.retryDeadline)!=null?x:1e4}};var E=t=>{uni.showLoading({title:t.title,mask:t.mask||!0});};var O=t=>typeof t=="object"&&t!==null?Object.keys(t).map(r=>`${r}=${encodeURIComponent(t[r])}`).join("&"):t;function v(t,r,e){let n=(i,o="")=>{e.errorHandleByCode&&e.errorHandleByCode(i,o);};return {request:i=>{var h,a;e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u3011${JSON.stringify(i)}`),e.loading&&E({title:(h=e.loadingText)!=null?h:"\u8BF7\u6C42\u4E2D..."}),(a=i==null?void 0:i.header)!=null&&a.contentType&&(i.header["content-type"]=i.header.contentType,delete i.header.contentType);let o="";process.env.NODE_ENV==="development"?o=e.baseUrl.dev:o=e.baseUrl.pro;let m=`${o}${r.url}`;return i.method==="GET"?(i.data=e.buildQueryString&&e.buildQueryString(i.data)?e.buildQueryString(i.data):O(i.data),i.url=`${m}?${i.data}`):i.url=m,r.before&&r.before(),t.request(i)},response:i=>(n(i.statusCode,i.data[e.requestSuccessResponseMsgName]),e.apiErrorInterception&&e.apiErrorInterception(i.data,i),e.debug&&console.warn(`\u3010LwuRequest Debug:\u54CD\u5E94\u62E6\u622A\u3011${JSON.stringify(i)}`),r.after&&r.after(),i),fail:i=>(e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5931\u8D25\u3011${JSON.stringify(i)}`),i),complete:i=>{uni.hideLoading(),e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210\u3011${JSON.stringify(i)}`);}}}var D=(t,r)=>{let e=Math.floor(Math.random()*1e3);return Math.min(Math.pow(2,t)*1e3+e,r)};var U=class{constructor(r){this.currentRequestTask={abort:()=>{},onHeadersReceived:()=>{},offHeadersReceived:()=>{}};this.requestTasksName="LWU-REQUEST-TASKS";this.lock=!0;this.pending=[];this.retryCount=3;this.retryMaximum=64;this.retryTimeout=[];this.retryDeadline=1e4;this.config={baseUrl:{pro:"",dev:""},errorHandleByCode:(r,e)=>{},apiErrorInterception:r=>{}};if(this.config=f({},w(r)),!this.config.retry)this.retryCount=0;else if(this.config.retryCountAutoOffRetry){this.retryMaximum=this.config.retryMaximum*1e3,this.retryTimeout=[],this.retryDeadline=r.retryDeadline;for(let e=0;e<this.retryCount&&!(this.retryDeadline<0);e++){let n=D(e,this.retryMaximum);this.retryDeadline-=n,this.retryTimeout.push(n);}this.retryCount=this.retryTimeout.length;}}handleError(r,e=""){this.config.errorHandleByCode&&this.config.errorHandleByCode(r,e);}refreshToken(){this.config.refreshTokenHandle&&this.config.refreshTokenHandle().then(()=>{uni.getStorageSync("LWU-REQUEST-CALLBACK")(r=>{r();});}).catch(()=>{this.handleError(this.config.tokenExpiredCode);});}request(r,e={},n={header:{},method:this.config.method,timeout:this.config.timeout,dataType:this.config.dataType,responseType:this.config.responseType,sslVerify:this.config.sslVerify,withCredentials:this.config.withCredentials,firstIpv4:this.config.firstIpv4,retryCount:this.config.retryCount}){var d;let l=uni.getStorageSync(this.requestTasksName);return n!=null&&n.task_id&&l[n==null?void 0:n.task_id]&&(this.config.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42ID${n.task_id}\u6709\u91CD\u590D\u9879\u5DF2\u81EA\u52A8\u8FC7\u6EE4`),(d=l[n==null?void 0:n.task_id])==null||d.abort()),new Promise((c,u)=>S(this,null,function*(){var h;let i=v({request:a=>(r=a.url,a),response:a=>a},{url:r,before:n.before,after:n.after,header:n.header},this.config);i.request({header:f({contentType:""},n.header),method:(h=n.method)!=null?h:"GET",data:e,url:r});let o=uni.getStorageSync(this.config.tokenStorageKeyName);(()=>new Promise((a,g)=>{o&&a(o),this.config.tokenValue?this.config.tokenValue().then(y=>{y&&a(y),a(!1);}):a("");}))().then(a=>{var g,y;if(a&&(this.config.takeTokenMethod==="header"&&(n.header=(g=n.header)!=null?g:{},n.header[(y=this.config)==null?void 0:y.takenTokenKeyName]=a),this.config.takeTokenMethod==="body"&&(e[this.config.takenTokenKeyName]=a)),this.currentRequestTask=uni.request({url:r,data:e,header:f({},n.header),method:n.method,timeout:n.timeout,dataType:n.dataType,responseType:n.responseType,sslVerify:n.sslVerify,withCredentials:n.withCredentials,firstIpv4:n.firstIpv4,success:s=>{i.response(s),typeof this.config.xhrCode!="undefined"&&this.config.xhrCodeName&&s.data[this.config.xhrCodeName]&&s.data[this.config.xhrCodeName]!==this.config.xhrCode&&u(s),s.statusCode!==this.config.tokenExpiredCode?c(s.data):(this.refreshToken(),uni.setStorageSync("LWU-REQUEST-CALLBACK",()=>{c(this.request(r,e,n));}));},fail:s=>{var b;i.fail(s),this.retryCount=(b=n.retryCount)!=null?b:3,this.retryCount===0?u(s):(this.config.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u81EA\u52A8\u91CD\u8BD5\u6B21\u6570\uFF1A${this.retryCount}`),this.retryCount--,setTimeout(this.request,this.retryTimeout.shift()),this.config.networkExceptionHandle&&this.config.networkExceptionHandle());},complete:s=>{i.complete(s);}}),n!=null&&n.task_id){let s=[];s[n==null?void 0:n.task_id]=this.currentRequestTask,uni.setStorageSync(this.requestTasksName,s);}});}))}get(r,e={},n={}){return this.request(r,e,f({method:"GET"},n))}post(r,e={},n={}){return this.request(r,e,f({method:"POST"},n))}put(r,e={},n={}){return this.request(r,e,f({method:"POST"},n))}delete(r,e={},n={}){return this.request(r,e,f({method:"DELETE"},n))}abort(r=""){let e=uni.getStorageSync(this.requestTasksName);e[r]?e[r].abort():this.currentRequestTask.abort();}};

exports.Http = U;
