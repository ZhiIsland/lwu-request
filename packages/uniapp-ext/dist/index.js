'use strict';

var N=Object.defineProperty;var q=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var R=(n,t,e)=>t in n?N(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,d=(n,t)=>{for(var e in t||(t={}))O.call(t,e)&&R(n,e,t[e]);if(q)for(var e of q(t))M.call(t,e)&&R(n,e,t[e]);return n};var S=(n,t,e)=>new Promise((r,h)=>{var y=a=>{try{u(e.next(a));}catch(o){h(o);}},b=a=>{try{u(e.throw(a));}catch(o){h(o);}},u=a=>a.done?r(a.value):Promise.resolve(a.value).then(y,b);u((e=e.apply(n,t)).next());});var w=n=>{var t,e,r,h,y,b,u,a,o,C,g,s,c,l,i,f,m,T,k,p,x;return {baseUrl:n.baseUrl,debug:(t=n.debug)!=null?t:!1,loading:(e=n.loading)!=null?e:!0,loadingText:(r=n.loadingText)!=null?r:"\u8BF7\u6C42\u4E2D...",timeout:(h=n.timeout)!=null?h:6e3,method:(y=n.method)!=null?y:"GET",dataType:(b=n.dataType)!=null?b:"json",responseType:(u=n.responseType)!=null?u:"text",sslVerify:(a=n.sslVerify)!=null?a:!0,withCredentials:(o=n.withCredentials)!=null?o:!1,firstIpv4:(C=n.firstIpv4)!=null?C:!1,errorHandleByCode:n.errorHandleByCode,apiErrorInterception:n.apiErrorInterception,networkExceptionHandle:()=>{},xhrCode:n.xhrCode,xhrCodeName:(g=n.xhrCodeName)!=null?g:"code",requestSuccessResponseMsgName:(s=n.requestSuccessResponseMsgName)!=null?s:"msg",tokenStorageKeyName:(c=n.tokenStorageKeyName)!=null?c:"",tokenValue:n.tokenValue,buildQueryString:n.buildQueryString,takeTokenMethod:(l=n.takeTokenMethod)!=null?l:"header",takenTokenKeyName:(i=n.takenTokenKeyName)!=null?i:"Authorization",autoRefreshToken:!1,refreshTokenHandle:n.refreshTokenHandle,tokenExpiredCode:(f=n.tokenExpiredCode)!=null?f:403,retry:(m=n.retry)!=null?m:!1,retryCount:(T=n.retryCount)!=null?T:3,retryCountAutoOffRetry:(k=n.retryCountAutoOffRetry)!=null?k:!0,retryMaximum:(p=n.retryMaximum)!=null?p:64,retryDeadline:(x=n.retryDeadline)!=null?x:1e4}};var E=n=>{uni.showLoading({title:n.title,mask:n.mask||!0});};var A=n=>typeof n=="object"&&n!==null?Object.keys(n).map(t=>`${t}=${encodeURIComponent(n[t])}`).join("&"):n;function v(n,t,e){let r=(a,o="")=>{e.errorHandleByCode&&e.errorHandleByCode(a,o);};return {request:a=>{var c,l,i;e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u3011${JSON.stringify(a)}`);let o=(c=t.loading)!=null?c:e.loading,C=(l=t.loadingText)!=null?l:e.loadingText;o&&E({title:C!=null?C:"\u8BF7\u6C42\u4E2D..."}),(i=a==null?void 0:a.header)!=null&&i.contentType&&(a.header["content-type"]=a.header.contentType,delete a.header.contentType);let g="";process.env.NODE_ENV==="development"?g=e.baseUrl.dev:g=e.baseUrl.pro;let s=`${g}${t.url}`;return a.method==="GET"?(a.data=e.buildQueryString&&e.buildQueryString(a.data)?e.buildQueryString(a.data):A(a.data),a.url=`${s}?${a.data}`):a.url=s,t.before&&t.before(),n.request(a)},response:a=>(r(a.statusCode,a.data[e.requestSuccessResponseMsgName]),e.debug&&console.warn(`\u3010LwuRequest Debug:\u54CD\u5E94\u62E6\u622A\u3011${JSON.stringify(a)}`),t.after&&t.after(),a),fail:a=>(e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5931\u8D25\u3011${JSON.stringify(a)}`),a),complete:a=>{uni.hideLoading(),e.debug&&console.warn(`\u3010LwuRequest Debug:\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210\u3011${JSON.stringify(a)}`);}}}var L=(n,t)=>{let e=Math.floor(Math.random()*1e3);return Math.min(Math.pow(2,n)*1e3+e,t)};var U=class{constructor(t){this.currentRequestTask={abort:()=>{},onHeadersReceived:()=>{},offHeadersReceived:()=>{}};this.requestTasksName="LWU-REQUEST-TASKS";this.lock=!0;this.pending=[];this.retryCount=3;this.retryMaximum=64;this.retryTimeout=[];this.retryDeadline=1e4;this.globalConfig={baseUrl:{pro:"",dev:""},errorHandleByCode:(t,e)=>{},apiErrorInterception:t=>{}};this.reqConfig={};if(this.globalConfig=d({},w(t)),this.reqConfig=this.globalConfig,!this.globalConfig.retry)this.retryCount=0;else if(this.globalConfig.retryCountAutoOffRetry){this.retryMaximum=this.globalConfig.retryMaximum*1e3,this.retryTimeout=[],this.retryDeadline=t.retryDeadline;for(let e=0;e<this.retryCount&&!(this.retryDeadline<0);e++){let r=L(e,this.retryMaximum);this.retryDeadline-=r,this.retryTimeout.push(r);}this.retryCount=this.retryTimeout.length;}}handleError(t,e=""){this.globalConfig.errorHandleByCode&&this.globalConfig.errorHandleByCode(t,e);}refreshToken(){this.globalConfig.refreshTokenHandle&&this.globalConfig.refreshTokenHandle().then(()=>{uni.getStorageSync("LWU-REQUEST-CALLBACK")(t=>{t();});}).catch(()=>{this.handleError(this.globalConfig.tokenExpiredCode);});}request(t,e={},r){var y;r=r!=null?r:this.reqConfig;let h=uni.getStorageSync(this.requestTasksName);return r!=null&&r.task_id&&h[r==null?void 0:r.task_id]&&(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u8BF7\u6C42ID${r.task_id}\u6709\u91CD\u590D\u9879\u5DF2\u81EA\u52A8\u8FC7\u6EE4`),(y=h[r==null?void 0:r.task_id])==null||y.abort()),new Promise((b,u)=>S(this,null,function*(){var g;let a=v({request:s=>(t=s.url,s),response:s=>s},d({url:t},r),this.globalConfig);a.request({header:d({contentType:""},r.header),method:(g=r.method)!=null?g:"GET",data:e,url:t});let o=uni.getStorageSync(this.globalConfig.tokenStorageKeyName);(()=>new Promise((s,c)=>{o&&s(o),this.globalConfig.tokenValue?this.globalConfig.tokenValue().then(l=>{l&&s(l),s(!1);}):s("");}))().then(s=>{var c,l;if(s&&(this.globalConfig.takeTokenMethod==="header"&&(r.header=(c=r.header)!=null?c:{},r.header[(l=this.globalConfig)==null?void 0:l.takenTokenKeyName]=s),this.globalConfig.takeTokenMethod==="body"&&(e[this.globalConfig.takenTokenKeyName]=s)),this.currentRequestTask=uni.request({url:t,data:e,header:d({},r.header),method:r.method,timeout:r.timeout,dataType:r.dataType,responseType:r.responseType,sslVerify:r.sslVerify,withCredentials:r.withCredentials,firstIpv4:r.firstIpv4,success:i=>{a.response(i),typeof this.globalConfig.xhrCode=="undefined"?this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(i.data,i):this.globalConfig.xhrCodeName&&i.data[this.globalConfig.xhrCodeName]&&i.data[this.globalConfig.xhrCodeName]!==this.globalConfig.xhrCode&&(this.globalConfig.apiErrorInterception&&this.globalConfig.apiErrorInterception(i.data,i),u(i)),i.statusCode!==this.globalConfig.tokenExpiredCode?b(i.data):(this.refreshToken(),uni.setStorageSync("LWU-REQUEST-CALLBACK",()=>{b(this.request(t,e,r));}));},fail:i=>{var f;a.fail(i),this.retryCount=(f=r.retryCount)!=null?f:3,this.retryCount===0?u(i):(this.globalConfig.debug&&console.warn(`\u3010LwuRequest Debug\u3011\u81EA\u52A8\u91CD\u8BD5\u6B21\u6570\uFF1A${this.retryCount}`),this.retryCount--,setTimeout(this.request,this.retryTimeout.shift()),this.globalConfig.networkExceptionHandle&&this.globalConfig.networkExceptionHandle());},complete:i=>{a.complete(i);}}),r!=null&&r.task_id){let i=[];i[r==null?void 0:r.task_id]=this.currentRequestTask,uni.setStorageSync(this.requestTasksName,i);}});}))}get(t,e={},r={}){return this.request(t,e,d({method:"GET"},r))}post(t,e={},r={}){return this.request(t,e,d({method:"POST"},r))}put(t,e={},r={}){return this.request(t,e,d({method:"POST"},r))}delete(t,e={},r={}){return this.request(t,e,d({method:"DELETE"},r))}config(t={}){return this.reqConfig=d({},t),this}abort(t=""){let e=uni.getStorageSync(this.requestTasksName);e[t]?e[t].abort():this.currentRequestTask.abort();}};

exports.Http = U;
